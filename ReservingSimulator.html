<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Specialty Line Reserving Simulator - Non-negative IBNR</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background:#f0f2f5; color:#333; padding:15px; text-align:center; }
h1{font-size:1.7em;margin-bottom:12px;}
h2{font-size:1.3em;margin-top:20px;margin-bottom:8px;}
.controls{margin:15px 0; display:flex; justify-content:center; gap:20px; flex-wrap: wrap;}
.control-group{display:flex; flex-direction:column; align-items:center;}
input[type=range]{width:160px;}
label{margin-top:5px; font-size:0.95em;}
canvas{
  background:white;
  border-radius:8px;
  margin:12px auto;
  display:block;
  width:800px;
  height:350px;
}
.writeup{margin-top:25px; max-width:800px; text-align:left; background:#fff; padding:15px; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.1);}
</style>
</head>
<body>

<h1>Specialty Line Reserving Simulator</h1>

<div class="controls">
  <div class="control-group">
    <label>Tail Factor: <span id="tailVal">1.0</span></label>
    <input type="range" min="1" max="2" step="0.01" value="1" id="tailSlider">
  </div>
  <div class="control-group">
    <label>Large-Loss Adjustment (%): <span id="llVal">0</span></label>
    <input type="range" min="0" max="50" step="1" value="0" id="llSlider">
  </div>
</div>

<h2>Ultimate Reserves by Accident Year</h2>
<canvas id="reserveChart" width="800" height="350"></canvas>

<h2>IBNR by Accident Year</h2>
<canvas id="ibnrChart" width="800" height="350"></canvas>

<script>
// ---------- Simulated Triangles (non-zero, realistic growth) ----------
const periods = 7;
let paidTriangle=[], reportedTriangle=[];
for(let i=0;i<periods;i++){
  let paidRow=[], repRow=[];
  for(let j=0;j<periods;j++){
    if(j<=i){
      // Generate growing triangle values to avoid negative IBNR
      let base = Math.round((Math.random()*50 + 50) * (i+1) * 10);
      paidRow.push(base);
      repRow.push(base + Math.round(Math.random()*20 * 10));
    } else {
      paidRow.push(null);
      repRow.push(null);
    }
  }
  paidTriangle.push(paidRow);
  reportedTriangle.push(repRow);
}

// ---------- Chain-Ladder & Bornhuetter-Ferguson ----------
function calcLDFs(triangle){
  const n=triangle.length;
  const ldfs=[];
  for(let j=0;j<n-1;j++){
    let sumNum=0, sumDen=0;
    for(let i=0;i<n-j-1;i++){
      if(triangle[i][j]!==null && triangle[i][j+1]!==null){
        sumNum += triangle[i][j+1];
        sumDen += triangle[i][j];
      }
    }
    ldfs.push(sumDen>0 ? sumNum/sumDen : 1);
  }
  ldfs.push(1);
  return ldfs;
}

function chainLadder(triangle, tailFactor=1, llAdj=0){
  const n = triangle.length;
  const ldfs = calcLDFs(triangle).map(x=>x*tailFactor);
  const ultimates = [];
  for(let i=0;i<n;i++){
    let latest = Math.max(1, triangle[i].filter(v=>v!==null).slice(-1)[0]);
    let remLDF=1;
    for(let j=i;j<ldfs.length-1;j++) remLDF*=ldfs[j];
    let ultimate = latest * remLDF * (1 + llAdj/100);
    ultimates.push(ultimate);
  }
  return ultimates;
}

function bornhuetterFerguson(triangle, tailFactor=1, llAdj=0){
  const n = triangle.length;
  const aPriori=[1500,1800,2100,2400,2700,3000,3300]; // ensure > latest
  const ldfs = calcLDFs(triangle).map(x=>x*tailFactor);
  const ultimates=[];
  for(let i=0;i<n;i++){
    let latest = Math.max(1, triangle[i].filter(v=>v!==null).slice(-1)[0]);
    let adjustedAP = Math.max(aPriori[i], latest); // ensure ultimate >= latest
    let remLDF=1;
    for(let j=i;j<ldfs.length-1;j++) remLDF*=ldfs[j];
    let ultimate = latest + (adjustedAP - latest)*(1 - remLDF);
    ultimate *= (1 + llAdj/100);
    ultimates.push(ultimate);
  }
  return ultimates;
}

// ---------- Initialize Charts ----------
const labels = Array.from({length:periods},(_,i)=>`AY ${i+1}`);
const clUltimateInit = chainLadder(reportedTriangle);
const bfUltimateInit = bornhuetterFerguson(reportedTriangle);
const clIBNRInit = clUltimateInit.map((v,i)=>Math.max(v - paidTriangle[i].filter(x=>x!==null).slice(-1)[0],0));
const bfIBNRInit = bfUltimateInit.map((v,i)=>Math.max(v - reportedTriangle[i].filter(x=>x!==null).slice(-1)[0],0));

const reserveChart = new Chart(document.getElementById('reserveChart'), {
  type:'bar',
  data:{
    labels,
    datasets:[
      {label:'CL Ultimate', data:clUltimateInit, backgroundColor:'#007bff', barPercentage:0.6, categoryPercentage:0.7},
      {label:'BF Ultimate', data:bfUltimateInit, backgroundColor:'#28a745', barPercentage:0.6, categoryPercentage:0.7}
    ]
  },
  options:{
    indexAxis:'y',
    responsive:false,
    maintainAspectRatio:false,
    layout:{padding:{top:10,bottom:20,left:40,right:20}},
    plugins:{
      title:{display:true,text:'Ultimate Reserves by Accident Year', font:{size:16, weight:'bold'}, padding:{top:8,bottom:8}},
      tooltip:{mode:'index', intersect:false}
    },
    scales:{
      x:{ticks:{font:{size:12}, callback: val=>val.toLocaleString()}},
      y:{ticks:{font:{size:12}}}
    }
  }
});

const ibnrChart = new Chart(document.getElementById('ibnrChart'), {
  type:'bar',
  data:{
    labels,
    datasets:[
      {label:'CL IBNR', data:clIBNRInit, backgroundColor:'#ff9933', barPercentage:0.6, categoryPercentage:0.7},
      {label:'BF IBNR', data:bfIBNRInit, backgroundColor:'#ffcc33', barPercentage:0.6, categoryPercentage:0.7}
    ]
  },
  options:{
    indexAxis:'y',
    responsive:false,
    maintainAspectRatio:false,
    layout:{padding:{top:10,bottom:20,left:40,right:20}},
    plugins:{
      title:{display:true,text:'IBNR by Accident Year', font:{size:16, weight:'bold'}, padding:{top:8,bottom:8}},
      tooltip:{mode:'index', intersect:false}
    },
    scales:{
      x:{ticks:{font:{size:12}, callback: val=>val.toLocaleString()}},
      y:{ticks:{font:{size:12}}}
    }
  }
});

// ---------- Update charts in-place ----------
function updateCharts(){
  const tailFactor = parseFloat(document.getElementById('tailSlider').value);
  const llAdj = parseFloat(document.getElementById('llSlider').value);
  document.getElementById('tailVal').innerText = tailFactor.toFixed(2);
  document.getElementById('llVal').innerText = llAdj;

  const clUltimate = chainLadder(reportedTriangle, tailFactor, llAdj);
  const bfUltimate = bornhuetterFerguson(reportedTriangle, tailFactor, llAdj);
  const clIBNR = clUltimate.map((v,i)=>Math.max(v - paidTriangle[i].filter(x=>x!==null).slice(-1)[0],0));
  const bfIBNR = bfUltimate.map((v,i)=>Math.max(v - reportedTriangle[i].filter(x=>x!==null).slice(-1)[0],0));

  reserveChart.data.datasets[0].data = clUltimate;
  reserveChart.data.datasets[1].data = bfUltimate;
  reserveChart.update({duration:0});

  ibnrChart.data.datasets[0].data = clIBNR;
  ibnrChart.data.datasets[1].data = bfIBNR;
  ibnrChart.update({duration:0});
}

// Event listeners
['tailSlider','llSlider'].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateCharts);
});
</script>

<div class="writeup">
<h2>Assumptions and Notes:</h2>
<ul>
<li>Simulated D&O/Cyber specialty line with realistic growth and positive claims.</li>
<li>Ultimate reserves estimated via Chain-Ladder (CL) and Bornhuetter-Ferguson (BF) methods.</li>
<li>BF ensures ultimate â‰¥ latest observed, eliminating negative IBNR.</li>
<li>Interactive sliders adjust tail factor and large-loss adjustment, always producing non-negative IBNR.</li>
<li>Fixed-size horizontal bars, stable on slider movement.</li>
</ul>
</div>

</body>
</html>

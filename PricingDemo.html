<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markel-Style Specialty Pricing Demo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f8f9fa; }
pre { background:#eee; padding:10px; border-radius:5px; max-height:250px; overflow:auto; }
table { width:100%; font-size:0.9rem; }
th,td { padding:5px; text-align:center; }
.slider-label { font-size:0.85rem; font-weight:bold; margin-top:0.5rem; }
</style>
</head>
<body class="p-3">
<div class="container">
  <h3>Markel-Style Specialty Pricing Demo</h3>

  <!-- Write-Up Section -->
  <div class="mt-3">
    <h4>Project Overview & Actuarial Context</h4>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Project Purpose</h5>
        <p>This interactive demo simulates a portfolio of niche insurance lines (Cyber, Marine, Excess) incorporating: credibility weighting, tail events, layer pricing, and additional actuarial factors affecting pricing decisions.</p>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Portfolio & Data Generation</h5>
        <ul>
          <li>5,000 synthetic policies across three lines</li>
          <li>Exposure and size factors included</li>
          <li>Claims simulated per policy with line-specific frequency and tail probabilities</li>
        </ul>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Credibility & External Benchmarks</h5>
        <p>Observed frequencies blended with external benchmarks using a credibility factor Z. Table below shows observed freq, adjusted freq, mean severity, tail thresholds.</p>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Simulation, Premiums & Interactive Factors</h5>
        <ul>
          <li>Monte Carlo simulations of portfolio losses</li>
          <li>Premium = expected loss × (1 + expense/profit loading) × market adjustment × reinsurance adjustment</li>
          <li>Interactive sliders allow adjusting tail stress, expenses, market, reinsurance, and diversification</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Interactive Inputs -->
  <div class="row mt-4">
    <div class="col-md-5">
      <h5>Severity Fit</h5>
      <select id="lineSelect" class="form-select">
        <option>Cyber</option>
        <option>Marine</option>
        <option>Excess</option>
      </select>
      <button id="fitBtn" class="btn btn-primary mt-2">Fit Severity</button>
      <pre id="fitOut" class="mt-2"></pre>

      <h5 class="mt-4">Layer Pricing</h5>
      <div class="input-group mb-2">
        <input id="attachment" class="form-control" placeholder="Attachment (e.g. 1000000)">
        <input id="limit" class="form-control" placeholder="Limit (e.g. 2000000)">
      </div>

      <!-- Interactive Sliders -->
      <div class="slider-label">Expense & Profit Loading (%)</div>
      <input type="range" id="expenseSlider" min="0" max="50" value="25" class="form-range">
      <div id="expenseValue">25%</div>

      <div class="slider-label">Tail Factor Multiplier</div>
      <input type="range" id="tailSlider" min="0.5" max="3" step="0.05" value="1" class="form-range">
      <div id="tailValue">1x</div>

      <div class="slider-label">Reinsurance Offset (%)</div>
      <input type="range" id="reinsSlider" min="0" max="100" value="0" class="form-range">
      <div id="reinsValue">0%</div>

      <div class="slider-label">Market Adjustment (%)</div>
      <input type="number" id="marketAdj" class="form-control mb-2" value="0">

      <div class="slider-label">Portfolio Diversification Factor (0-1)</div>
      <input type="range" id="diversSlider" min="0" max="1" step="0.05" value="1" class="form-range">
      <div id="diversValue">1.0</div>

      <!-- Regenerate Portfolio -->
      <button id="regenBtn" class="btn btn-warning mt-2">Regenerate Portfolio</button>
      <button id="priceLayerBtn" class="btn btn-secondary mt-3">Price Layer</button>
      <pre id="layerOut"></pre>
    </div>

    <!-- Summary Table & Charts -->
    <div class="col-md-7">
      <h5>Portfolio Summary with Credibility</h5>
      <div id="summary"></div>
      <canvas id="lossHist" height="200" class="mt-2"></canvas>
      <canvas id="lineChart" height="200" class="mt-2"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ----- Line Info -----
const lineInfo = {
  Cyber:  { baseFreq: 0.05, externalFreq: 0.06, scale: 20000, label: "High freq, Low-Med severity", tailProb:0.05 },
  Marine: { baseFreq: 0.02, externalFreq: 0.025, scale: 50000, label: "Medium freq, Medium severity", tailProb:0.03 },
  Excess: { baseFreq: 0.015, externalFreq:0.02, scale:150000, label:"Low freq, Very High severity", tailProb:0.02 }
};
const lines = Object.keys(lineInfo);
let policies=[], claims=[];

// ----- Synthetic Portfolio -----
function generatePortfolio(){
  policies=[]; claims=[]; let claim_id=1;
  for(let i=1;i<=5000;i++){
    const line = lines[Math.floor(Math.random()*lines.length)];
    const size = Math.random()<0.6?'Small':Math.random()<0.5?'Medium':'Large';
    const exposure = +(Math.random()*1.5 + 0.5).toFixed(3);
    policies.push({policy_id:i,line,line, exposure, size});
  }
  // Generate claims
  policies.forEach(p=>{
    const info=lineInfo[p.line];
    const lam=info.baseFreq*p.exposure;
    const numClaims=Math.random()<lam ?1:Math.floor(Math.random()*Math.max(lam*2,1));
    for(let i=0;i<numClaims;i++){
      const isTail=Math.random()<info.tailProb;
      const sev = isTail ? info.scale/Math.pow(Math.random(),1.5) : Math.exp(Math.log(info.scale)+Math.random()*0.8);
      claims.push({claim_id:claim_id++,policy_id:p.policy_id,line:p.line,amount:sev});
    }
  });
  // Adjusted Frequencies
  lines.forEach(line=>{
    const lineClaims=claims.filter(c=>c.line===line);
    const Z = credibility(lineClaims.length);
    const observedFreq=lineClaims.length/policies.filter(p=>p.line===line).length;
    lineAdjustedFreq[line]={Z, adjustedFreq: Z*observedFreq + (1-Z)*lineInfo[line].externalFreq, observedFreq};
  });
}

// ----- Credibility -----
function credibility(numClaims,k=50){ return Math.min(numClaims/k,1); }

// ----- Adjusted Frequencies -----
const lineAdjustedFreq = {};
generatePortfolio();

// ----- Portfolio Summary -----
function summaryTable(){
  let html='<table class="table table-bordered"><tr><th>Line</th><th>Label</th><th>Observed Freq</th><th>Z</th><th>Adjusted Freq</th><th>Mean Severity</th><th>Tail Threshold</th></tr>';
  lines.forEach(line=>{
    const info=lineInfo[line];
    const lineClaims=claims.filter(c=>c.line===line);
    const meanSeverity=lineClaims.reduce((a,b)=>a+b.amount,0)/lineClaims.length||0;
    const tailThreshold=lineClaims.sort((a,b)=>a.amount-b.amount)[Math.floor(lineClaims.length*0.95)]?.amount||0;
    const adj=lineAdjustedFreq[line];
    html+=`<tr><td>${line}</td><td>${info.label}</td><td>${adj.observedFreq.toFixed(3)}</td><td>${adj.Z.toFixed(3)}</td><td>${adj.adjustedFreq.toFixed(3)}</td><td>$${Math.round(meanSeverity)}</td><td>$${Math.round(tailThreshold)}</td></tr>`;
  });
  html+='</table>';
  document.getElementById('summary').innerHTML=html;
}

// ----- Severity Fit -----
function fitSeverity(line){
  const data=claims.filter(c=>c.line===line).map(c=>c.amount);
  const logs=data.map(a=>Math.log(a));
  const mu=logs.reduce((a,b)=>a+b,0)/logs.length;
  const sigma=Math.sqrt(logs.map(a=>(a-mu)**2).reduce((a,b)=>a+b,0)/(logs.length-1));
  const threshold=data.sort((a,b)=>a-b)[Math.floor(data.length*0.95)];
  return {dist:'lognormal',mu,sigma,tail_threshold:threshold};
}

// ----- Portfolio Simulation -----
function simulatePortfolio(attachment,limit,tailFactor,expenseLoad,reinsOffset,marketAdj,diversFactor){
  const sims=[]; const simCount=500;
  for(let i=0;i<simCount;i++){
    let total=0;
    lines.forEach(line=>{
      const info=lineInfo[line];
      const policiesLine=policies.filter(p=>p.line===line);
      const adj=lineAdjustedFreq[line];
      const lam=adj.adjustedFreq;
      policiesLine.forEach(p=>{
        const expectedClaims = lam*p.exposure;
        const count=Math.max(1,Math.floor(expectedClaims*(0.8+Math.random()*0.4)));
        for(let j=0;j<count;j++){
          const isTail=Math.random()<info.tailProb;
          const sev = isTail ? info.scale*tailFactor/Math.pow(Math.random(),1.5) : Math.exp(Math.log(info.scale)+Math.random()*0.8);
          total+=sev;
        }
      });
    });
    total*=diversFactor;
    sims.push(total);
  }
  const losses = sims.map(x=>Math.min(Math.max(x-attachment,0),limit)*(1-reinsOffset));
  const el = losses.reduce((a,b)=>a+b,0)/losses.length;
  const premium = el*(1+expenseLoad)*(1+marketAdj);
  return {expected_loss:el, premium, sims};
}

// ----- Charts -----
function renderLineChart(){
  const labels = lines;
  const observed = lines.map(line => lineAdjustedFreq[line].observedFreq);
  const adjusted = lines.map(line => lineAdjustedFreq[line].adjustedFreq);
  const tail = lines.map(line=>{
    const lineClaims = claims.filter(c=>c.line===line);
    return lineClaims.sort((a,b)=>a.amount-b.amount)[Math.floor(lineClaims.length*0.95)]?.amount||0;
  });
  const ctx = document.getElementById('lineChart').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Observed Freq', data:observed, backgroundColor:'rgba(54,162,235,0.6)'},
      {label:'Adjusted Freq', data:adjusted, backgroundColor:'rgba(75,192,192,0.6)'},
      {label:'Tail Threshold ($)', data:tail, backgroundColor:'rgba(255,99,132,0.6)', yAxisID:'y1'}
    ]},
    options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Frequency'}},y1:{beginAtZero:true,position:'right',title:{display:true,text:'Tail Threshold ($)'}}}}
  });
}
summaryTable(); renderLineChart();

// ----- Event Listeners -----
document.getElementById('fitBtn').addEventListener('click',()=>{
  const line=document.getElementById('lineSelect').value;
  document.getElementById('fitOut').innerText=JSON.stringify(fitSeverity(line),null,2);
});

['expenseSlider','tailSlider','reinsSlider','diversSlider'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const val=document.getElementById(id).value;
    if(id==='expenseSlider') document.getElementById('expenseValue').innerText=`${val}%`;
    else if(id==='tailSlider') document.getElementById('tailValue').innerText=`${val}x`;
    else if(id==='reinsSlider') document.getElementById('reinsValue').innerText=`${val}%`;
    else if(id==='diversSlider') document.getElementById('diversValue').innerText=`${val}`;
  });
});

document.getElementById('priceLayerBtn').addEventListener('click',()=>{
  const attachment=+document.getElementById('attachment').value||1000000;
  const limit=+document.getElementById('limit').value||2000000;
  const tailFactor=+document.getElementById('tailSlider').value;
  const expenseLoad=+document.getElementById('expenseSlider').value/100;
  const reinsOffset=+document.getElementById('reinsSlider').value/100;
  const marketAdj=+document.getElementById('marketAdj').value/100;
  const diversFactor=+document.getElementById('diversSlider').value;
  const result = simulatePortfolio(attachment,limit,tailFactor,expenseLoad,reinsOffset,marketAdj,diversFactor);
  document.getElementById('layerOut').innerText=JSON.stringify(result,null,2);
  const ctx=document.getElementById('lossHist').getContext('2d');
  new Chart(ctx,{type:'bar',data:{labels:[...Array(10).keys()],datasets:[{label:'Simulated Loss Bins',data:result.sims.slice(0,10)}]}});
});

document.getElementById('regenBtn').addEventListener('click',()=>{
  generatePortfolio();
  summaryTable();
  renderLineChart();
  document.getElementById('layerOut').innerText="Portfolio regenerated. Adjust sliders and price layer.";
  document.getElementById('fitOut').innerText="";
});
</script>
</body>
</html>
